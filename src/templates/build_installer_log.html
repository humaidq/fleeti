{{ template "head" . }}

<div class="page-header">
  <h2>Installer Build Log</h2>
  <div class="page-header-actions">
    <a href="/builds/{{ .Build.ID }}" class="btn">Back to Build</a>
  </div>
</div>

<section id="installer-log-viewer" class="section-card" data-build-id="{{ .Build.ID }}" data-initial-status="{{ .Build.InstallerStatus }}">
  <div class="build-log-meta">
    <div class="build-log-meta-item">
      <span class="muted-text">Build ID</span>
      <code>{{ .Build.ID }}</code>
    </div>
    <div class="build-log-meta-item">
      <span class="muted-text">Version</span>
      <strong>{{ .Build.Version }}</strong>
    </div>
    <div class="build-log-meta-item">
      <span class="muted-text">Profile</span>
      <span>{{ .Build.ProfileName }} (r{{ .Build.ProfileRevision }})</span>
    </div>
    <div class="build-log-meta-item">
      <span class="muted-text">Created (UTC)</span>
      <span>{{ .Build.CreatedAt }}</span>
    </div>
  </div>

  <div class="build-log-status-row">
    <span class="muted-text">Installer Status</span>
    {{ if eq .Build.InstallerStatus "not_requested" }}
    <span id="installer-log-status" class="muted-text">not_requested</span>
    {{ else }}
    <span id="installer-log-status" class="status-badge status-{{ .Build.InstallerStatus }}">{{ .Build.InstallerStatus }}</span>
    {{ end }}
  </div>

  <p id="installer-log-hint" class="muted-text">Loading installer build log history...</p>
  <pre id="installer-log-output" class="build-log-output" aria-live="polite"></pre>
  <p id="installer-log-error" class="build-log-error"></p>
</section>

<script>
  (() => {
    const viewerEl = document.getElementById("installer-log-viewer");
    const outputEl = document.getElementById("installer-log-output");
    const statusEl = document.getElementById("installer-log-status");
    const hintEl = document.getElementById("installer-log-hint");
    const errorEl = document.getElementById("installer-log-error");

    if (!viewerEl || !outputEl || !statusEl || !hintEl || !errorEl) {
      return;
    }

    const buildID = viewerEl.dataset.buildId || "";
    const initialStatus = viewerEl.dataset.initialStatus || "";

    if (buildID.length === 0) {
      errorEl.textContent = "Unable to start live installer log stream: missing build id.";

      return;
    }

    let after = 0;
    let stopped = false;

    function isTerminalStatus(status) {
      return status === "succeeded" || status === "failed";
    }

    function updateStatus(status) {
      if (typeof status !== "string" || status.length === 0) {
        return;
      }

      statusEl.textContent = status;
      if (status === "not_requested") {
        statusEl.className = "muted-text";

        return;
      }

      statusEl.className = "status-badge status-" + status;
    }

    function appendChunk(chunk) {
      if (typeof chunk !== "string" || chunk.length === 0) {
        return;
      }

      const stickToBottom = outputEl.scrollTop + outputEl.clientHeight >= outputEl.scrollHeight - 32;
      outputEl.append(document.createTextNode(chunk));

      if (stickToBottom) {
        outputEl.scrollTop = outputEl.scrollHeight;
      }
    }

    async function poll() {
      if (stopped) {
        return;
      }

      try {
        const response = await fetch(`/builds/${encodeURIComponent(buildID)}/installer/logs/live?after=${encodeURIComponent(after)}`, {
          cache: "no-store",
          headers: {
            Accept: "application/json"
          }
        });

        if (!response.ok) {
          throw new Error(`request failed with status ${response.status}`);
        }

        const payload = await response.json();
        errorEl.textContent = "";

        appendChunk(payload.chunk);

        if (typeof payload.next_after === "number" && payload.next_after >= after) {
          after = payload.next_after;
        }

        updateStatus(payload.status);

        if (payload.done === true) {
          hintEl.textContent = "Installer build finished. Showing persisted log history.";
          stopped = true;

          return;
        }

        hintEl.textContent = isTerminalStatus(payload.status)
          ? "Installer build finished. Showing persisted log history."
          : "Streaming installer build output live from stored logs...";

        const hasChunk = typeof payload.chunk === "string" && payload.chunk.length > 0;
        setTimeout(poll, hasChunk ? 150 : 1000);
      } catch (error) {
        const message = error instanceof Error ? error.message : "unknown error";
        errorEl.textContent = `Installer log unavailable: ${message}. Retrying...`;
        setTimeout(poll, 2000);
      }
    }

    updateStatus(initialStatus);
    hintEl.textContent = isTerminalStatus(initialStatus)
      ? "Loading persisted installer log history..."
      : "Connecting to live installer build output...";
    poll();
  })();
</script>

{{ template "foot" . }}
