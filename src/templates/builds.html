{{ template "head" . }}

<div class="page-header">
  <h2>Builds</h2>
  <div class="page-header-actions">
    <a href="/" class="btn">Dashboard</a>
  </div>
</div>

<section class="section-card">
  <h3>Create Build</h3>
  <details class="add-item-details">
    <summary class="add-item-summary">+ Create Build</summary>
    <form method="post" action="/builds" class="add-item-form">
      <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
      <div class="add-item-field">
        <label for="build-profile">Profile</label>
        <select id="build-profile" name="profile_id" class="form-item" required>
          <option value="">Select profile</option>
          {{ range .Profiles }}
          <option value="{{ .ID }}">{{ .Name }}</option>
          {{ end }}
        </select>
        <small class="muted-text">Build uses the latest profile revision.</small>
      </div>
      <div class="add-item-field">
        <label for="build-fleet">Fleet</label>
        <select id="build-fleet" name="fleet_id" class="form-item" required>
          <option value="">Select fleet</option>
          {{ range .Fleets }}
          <option value="{{ .ID }}">{{ .Name }}</option>
          {{ end }}
        </select>
        <small class="muted-text">Selected fleet must be assigned to this profile.</small>
      </div>
      <div class="add-item-field">
        <label for="build-version">Version</label>
        <input id="build-version" name="version" class="form-item" placeholder="v1.1.0" pattern="^v[0-9]+\.[0-9]+\.[0-9]+(?:-[0-9A-Za-z.-]+)?(?:\+[0-9A-Za-z.-]+)?$" title="Use semver with v prefix, for example v1.1.0" required />
      </div>
      <div class="add-item-field">
        <p class="muted-text">Build status and artifact path are set automatically after the Nix build finishes.</p>
      </div>
      <button type="submit" class="btn">Create Build</button>
    </form>
  </details>
</section>

<section class="section-card">
  <h3>Build Queue</h3>
  {{ if .Builds }}
  <div class="list-card-list">
    {{ range .Builds }}
    <div class="list-card list-card-clickable build-list-card">
      <a href="/builds/{{ .ID }}" class="list-card-link list-card-entry-link">
        <div class="list-card-entry">
          <span class="list-card-leading">
            <span class="list-card-icon" aria-hidden="true"><i class="fa-solid fa-hammer"></i></span>
          </span>
          <div class="list-card-entry-body">
            <div class="list-card-title">{{ .Version }}</div>
            <div class="list-card-meta build-list-meta">
              <span class="muted-text">Profile: {{ .ProfileName }} (r{{ .ProfileRevision }})</span>
              <span class="muted-text">Fleet: {{ if .FleetName }}{{ .FleetName }}{{ else }}-{{ end }}</span>
              <span class="muted-text">Build status: <span class="status-badge status-{{ .Status }}">{{ .Status }}</span></span>
              <span class="muted-text">Installer status: {{ if eq .InstallerStatus "not_requested" }}not_requested{{ else }}<span class="status-badge status-{{ .InstallerStatus }}">{{ .InstallerStatus }}</span>{{ end }}</span>
              <span class="muted-text">Created (UTC): {{ .CreatedAt }}</span>
            </div>
          </div>
        </div>
      </a>
    </div>
    {{ end }}
  </div>
  {{ else }}
  <p class="muted-text">No builds yet.</p>
  {{ end }}
</section>

{{ template "foot" . }}
