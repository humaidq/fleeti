{{ template "head" . }}

<div class="page-header">
  <h2>Releases</h2>
  <div class="page-header-actions">
    <a href="/" class="btn">Dashboard</a>
  </div>
</div>

<section class="section-card">
  <h3>Create Release</h3>
  <details class="add-item-details">
    <summary class="add-item-summary">+ Create Release</summary>
    <form method="post" action="/releases" class="add-item-form">
      <div class="add-item-field">
        <label for="release-build">Build</label>
        <select id="release-build" name="build_id" class="form-item" required>
          <option value="">Select build</option>
          {{ range .Builds }}
          <option value="{{ .ID }}" data-build-version="{{ .Version }}">{{ .Version }} ({{ .ProfileName }}{{ if .FleetName }} - {{ .FleetName }}{{ end }})</option>
          {{ end }}
        </select>
      </div>
      <div class="add-item-field">
        <label for="release-version">Release Version</label>
        <input id="release-version" name="version" class="form-item" placeholder="v1.1.0" pattern="^v[0-9]+\.[0-9]+\.[0-9]+(?:-[0-9A-Za-z.-]+)?(?:\+[0-9A-Za-z.-]+)?$" title="Use semver with v prefix, for example v1.1.0" required />
      </div>
      <div class="add-item-field">
        <label for="release-channel">Channel</label>
        <input id="release-channel" name="channel" class="form-item" value="stable" />
      </div>
      <div class="add-item-field">
        <label for="release-notes">Notes</label>
        <textarea id="release-notes" name="notes" class="form-item" rows="3"></textarea>
      </div>
      <button type="submit" class="btn">Create Release</button>
    </form>
  </details>
</section>

<section class="section-card">
  <h3>Published Releases</h3>
  {{ if .Releases }}
  <div class="list-card-list">
    {{ range .Releases }}
    <div class="list-card release-list-card">
      <a href="/releases/{{ .ID }}" class="list-card-link list-card-entry-link">
        <div class="list-card-entry">
          <span class="list-card-leading">
            <span class="list-card-icon" aria-hidden="true"><i class="fa-solid fa-tag"></i></span>
          </span>
          <div class="list-card-entry-body">
            <div class="list-card-title">{{ .Version }}</div>
            <div class="list-card-meta release-list-meta">
              <span class="muted-text">Channel: <span class="badge">{{ .Channel }}</span></span>
              <span class="muted-text">Status: <span class="status-badge status-{{ .Status }}">{{ if eq .Status "withdrawn" }}taken down{{ else }}{{ .Status }}{{ end }}</span></span>
              <span class="muted-text">Fleet: {{ if .FleetName }}{{ .FleetName }}{{ else }}-{{ end }}</span>
              <span class="muted-text">Build: {{ .Build }}</span>
              <span class="muted-text">Profile: {{ .ProfileName }}</span>
              <span class="muted-text">Published (UTC): {{ .PublishedAt }}</span>
            </div>
          </div>
        </div>
      </a>
    </div>
    {{ end }}
  </div>
  {{ else }}
  <p class="muted-text">No releases yet.</p>
  {{ end }}
</section>

<script>
  (() => {
    const buildSelect = document.getElementById("release-build")
    const versionInput = document.getElementById("release-version")
    if (!buildSelect || !versionInput) {
      return
    }

    const syncReleaseVersionFromBuild = () => {
      const selectedOption = buildSelect.options[buildSelect.selectedIndex]
      if (!selectedOption) {
        return
      }

      const buildVersion = selectedOption.getAttribute("data-build-version")
      if (!buildVersion) {
        return
      }

      versionInput.value = buildVersion
    }

    buildSelect.addEventListener("change", syncReleaseVersionFromBuild)
    syncReleaseVersionFromBuild()
  })()
</script>

{{ template "foot" . }}
