{{ template "head" . }}

{{ if .Breadcrumbs }}
<nav class="breadcrumb" aria-label="Breadcrumb">
  {{ range $i, $b := .Breadcrumbs }}
    {{ if $i }}<span class="breadcrumb-separator">&gt;</span>{{ end }}
    {{ if $b.IsCurrent }}
      <span class="breadcrumb-current">{{ $b.Name }}</span>
    {{ else }}
      <a href="{{ $b.URL }}" class="breadcrumb-item">{{ $b.Name }}</a>
    {{ end }}
  {{ end }}
</nav>
{{ end }}

<div class="page-header">
  <h2>Profile Settings</h2>
  <div class="page-header-actions">
    <a href="/profiles/{{ .Profile.ID }}" class="btn">View Summary</a>
    <a href="/profiles" class="btn">Back to Profiles</a>
  </div>
</div>

<section class="section-card">
  <h3>{{ .Profile.Name }}</h3>
  <p class="muted-text">
    Current revision: r{{ .Profile.LatestRevision }}
    {{ if .Profile.ConfigHash }}<span> - <code>{{ .Profile.ConfigHash }}</code></span>{{ end }}
  </p>
  <p class="muted-text">Visibility: {{ if eq .Profile.Visibility "visible" }}visible{{ else }}private{{ end }}</p>
  {{ template "profile_nav" . }}
</section>

{{ if .IsAdmin }}
<section class="section-card">
  <h3>Visibility</h3>
  <form method="post" action="/profiles/{{ .Profile.ID }}/visibility" class="form-grid">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <div class="form-group">
      <label for="profile-visibility">Visibility</label>
      <select id="profile-visibility" name="visibility" class="form-item">
        <option value="private"{{ if eq .Profile.Visibility "private" }} selected{{ end }}>Private</option>
        <option value="visible"{{ if eq .Profile.Visibility "visible" }} selected{{ end }}>Visible</option>
      </select>
      <small class="muted-text">Only admins can change visibility permissions.</small>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn">Save Visibility</button>
    </div>
  </form>
</section>

<section class="section-card">
  <h3>Specific Viewers</h3>
  <p class="muted-text">Grant individual users read access to this profile even when private.</p>

  {{ if .ProfileViewers }}
  <div class="list-card-list">
    {{ range .ProfileViewers }}
    <div class="list-card">
      <div class="list-card-title">{{ .DisplayName }}</div>
      <div class="list-card-meta">
        <form method="post" action="/profiles/{{ $.Profile.ID }}/viewers/{{ .ID }}/delete" class="inline-form">
          <input type="hidden" name="_csrf" value="{{ $.csrf_token }}" />
          <button type="submit" class="btn btn-danger">Remove</button>
        </form>
      </div>
    </div>
    {{ end }}
  </div>
  {{ else }}
  <p class="muted-text">No specific viewers yet.</p>
  {{ end }}

  <form method="post" action="/profiles/{{ .Profile.ID }}/viewers" class="form-grid">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <div class="form-group">
      <label for="profile-viewer-user-id">Add viewer</label>
      <select id="profile-viewer-user-id" name="user_id" class="form-item">
        <option value="">Select user</option>
        {{ range .ViewerUsers }}
        <option value="{{ .ID }}">{{ .DisplayName }}</option>
        {{ end }}
      </select>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn">Add Viewer</button>
    </div>
  </form>
</section>
{{ end }}

<section class="section-card">
  <h3>Metadata</h3>
  <form method="post" action="/profiles/{{ .Profile.ID }}/edit">
    <input type="hidden" name="_csrf" value="{{ .csrf_token }}" />
    <div class="form-group">
      <label for="profile-fleets">Fleets</label>
      <select id="profile-fleets" name="fleet_ids" class="form-item" multiple required>
        {{ range .Fleets }}
        <option value="{{ .ID }}"{{ if index $.SelectedFleetIDs .ID }} selected{{ end }}>{{ .Name }}</option>
        {{ end }}
      </select>
      <small class="muted-text">Hold Ctrl (or Cmd on macOS) to select multiple fleets.</small>
    </div>
    <div class="form-group">
      <label for="profile-name">Name</label>
      <input id="profile-name" name="name" class="form-item" value="{{ .Profile.Name }}" required />
    </div>
    <div class="form-group">
      <label for="profile-description">Description</label>
      <textarea id="profile-description" name="description" class="form-item" rows="3">{{ .Profile.Description }}</textarea>
    </div>
    <p class="muted-text">Updating fleets, name, or description changes metadata only.</p>
    <div class="form-actions">
      <button type="submit" class="btn">Save Settings</button>
      <a href="/profiles" class="btn">Cancel</a>
    </div>
  </form>
</section>

{{ template "foot" . }}
